<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PIM Activations</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e5e7eb;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header,main{max-width:1150px;margin:auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  h1{font-size:20px;margin:0}
  .btn{background:#111827;color:#fff;border:0;border-radius:999px;padding:8px 14px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .filters{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin:10px 0}
  .filters input,.filters select{border:1px solid var(--border);border-radius:10px;padding:8px;background:#fff}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
  table{border-collapse:separate;border-spacing:0;width:100%}
  thead th{position:sticky;top:0;background:#f9fafb;border-bottom:1px solid var(--border);text-align:left;padding:8px;z-index:1}
  tbody td{padding:8px;border-bottom:1px solid var(--border)}
  tbody tr:nth-child(even){background:#fafafa}
  .chip{padding:2px 8px;border-radius:999px;display:inline-block}
  .ok{background:#dcfce7} .bad{background:#fee2e2} .muted{color:#64748b}
  .banner{padding:10px;border-radius:12px;margin:10px 0}
  .error{background:#fee2e2;color:#991b1b}
  .info{background:#fef9c3;color:#78350f}
  .flex{display:flex;align-items:center;gap:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  canvas{width:100%;height:180px;display:block}
  .footer{color:var(--muted);font-size:12px;margin:6px 0 6px;text-align:center}
  .copyright{color:var(--muted);font-size:12px;text-align:right;margin-top:8px}

  /* links */
  a.upn-link{color:#0ea5e9;text-decoration:underline;cursor:pointer}

  /* User Role Summary */
  .summary-title{font-weight:600;margin:0 0 8px 0}
  .summary-row{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:6px; align-items:center;
    padding:6px 8px; border-radius:10px; background:#f9fafb; border:1px solid var(--border);
  }
  .summary-role{ text-align:left; justify-self:start; overflow-wrap:anywhere; }
  .summary-count{ text-align:right; justify-self:end; font-variant-numeric:tabular-nums; }

  /* Eligible roles list */
  .elig-wrap{margin-top:12px}
  .elig-title{margin:10px 0 6px 0; font-weight:600}
  .elig-list{display:grid; gap:6px}
  .elig-item{
    display:grid; grid-template-columns: 1fr auto auto; /* info | badge | last activated */
    gap:6px; align-items:center;
    padding:6px 8px; border-radius:10px; background:#fff; border:1px solid var(--border);
  }
  .elig-badge{font-size:12px; padding:2px 8px; border-radius:999px; background:#eef2ff}
  .perm-badge{font-size:12px; padding:2px 8px; border-radius:999px; background:#fee2e2; color:#991b1b; font-weight:600}
  .pim-badge{font-size:10px; margin-left:6px; padding:1px 6px; border-radius:999px; background:#ede9fe; color:#4c1d95; font-weight:600}
  .pag-badge{font-size:10px; margin-left:6px; padding:1px 6px; border-radius:999px; background:#ecfeff; color:#0e7490; font-weight:600}
  .elig-dim{color:#64748b; font-size:12px}
  .elig-last{font-size:12px; text-align:right; white-space:nowrap}
  .x-badge{
    display:inline-block; font-weight:700; padding:0 8px; border-radius:999px;
    background:#fee2e2; color:#991b1b; line-height:20px;
  }
</style>
</head>
<body>

<header>
  <h1>PIM Activations</h1>
  <div class="flex">
    <button id="resetBtn" class="btn" title="Clear all filters and reset the view">Reset view</button>
    <button id="exportBtn" class="btn" disabled>Export view</button>
    <button id="exportUserSummaryBtn" class="btn" disabled>Export user summary</button>
  </div>
</header>

<main>
  <div id="banner" class="banner info" style="display:none"></div>

  <div class="filters">
    <input id="q" placeholder="Search…">
    <select id="role"><option value="">All roles</option></select>
    <select id="user"><option value="">All users</option></select>
    <select id="result"><option value="">All results</option><option>success</option><option>failure</option></select>
    <div class="grid2" style="grid-column: span 2;">
      <input id="from" type="date" title="From date">
      <input id="to" type="date" title="To date">
    </div>
  </div>

  <div class="card" style="margin:10px 0">
    <canvas id="trend"></canvas>
  </div>

  <!-- User Role Summary -->
  <div class="card" id="userSummaryCard">
    <h3 class="summary-title">User Role Summary</h3>

    <div id="userSummaryBody"></div>
    <div id="userSummaryNote" class="muted" style="margin-top:6px;"></div>

    <!-- Eligible roles -->
    <div class="elig-wrap">
      <div class="elig-title" id="eligTitle">Eligible roles</div>
      <div class="elig-dim" id="eligHint" style="margin-bottom:6px">
        Last activated = most recent completed PIM activation. ✖ = never activated.
        Standing access shows as <strong style="color:#991b1b">Perm active</strong>.
      </div>
      <div id="eligibleRolesBody" class="elig-list"></div>
      <div id="eligibleRolesNote" class="elig-dim"></div>
    </div>
  </div>

  <div class="card" style="overflow:auto">
    <table id="tbl">
      <thead>
        <tr>
          <th>Timestamp</th><th>MemberUPN</th><th>Member</th><th>Role</th>
          <th>Justification</th><th>Ticket</th><th>Activity</th><th>Result</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td class="muted" colspan="7">Loading…</td></tr></tbody>
    </table>
  </div>

  <div class="footer">
    This page auto-loads <code>PIM_Activations.data.js</code>, <code>AdministratorsReport-PIM.data.js</code>, and <code>AdministratorsReport-PAG.data.js</code> generated by your PowerShell.
  </div>
  <div class="copyright">© <span id="year"></span> Andy Royston</div>
</main>

<!-- Offline data bundles written by your PowerShell -->
<script src="./PIM_Activations.data.js"></script>
<script src="./AdministratorsReport-PIM.data.js"></script>
<script src="./AdministratorsReport-PAG.data.js"></script>

<script>
(function(){
  document.getElementById('year').textContent = new Date().getFullYear();

  const el = id => document.getElementById(id);
  const resetBtn = el('resetBtn');
  const exportBtn = el('exportBtn');
  const exportUserSummaryBtn = el('exportUserSummaryBtn');
  const banner = el('banner');

  const q = el('q'), role = el('role'), user = el('user'), result = el('result'), from = el('from'), to = el('to');
  const tbody = el('tbody');
  const trendCanvas = el('trend');

  const userSummaryCard = el('userSummaryCard');
  const userSummaryBody = el('userSummaryBody');
  const userSummaryNote = el('userSummaryNote');

  const eligTitle = el('eligTitle');
  const eligHint = el('eligHint');
  const eligibleRolesBody = el('eligibleRolesBody');
  const eligibleRolesNote = el('eligibleRolesNote');

  let rows = [];
  let filtered = [];

  function showInfo(msg){ banner.className = 'banner info'; banner.textContent = msg; banner.style.display='block'; }
  function hideBanner(){ banner.style.display='none'; }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"})[c]); }

  function normalize(arr){
    return (Array.isArray(arr)?arr:[]).map(r=>({
      Timestamp: r.Timestamp ?? r.timestamp ?? "",
      MemberUPN: r.MemberUPN ?? "",
      Member: r.Member ?? "",
      Role: r.Role ?? "",
      Justification: r.Justification ?? "",
      Ticket: r.Ticket ?? r.TicketNumber ?? "",
      Activity: r.Activity ?? "",
      Result: r.Result ?? ""
    }));
  }

  // ensure an option exists in a select
  function ensureOption(sel, val){
    const opts = Array.from(sel.options).map(o=>o.value);
    if (val && !opts.includes(val)){
      const opt = document.createElement('option');
      opt.value = opt.textContent = val;
      sel.appendChild(opt);
    }
  }

  function findDisplayName(upn){
    upn = (upn||'').toLowerCase();
    const r = rows.find(x => (x.MemberUPN||'').toLowerCase() === upn);
    return r ? (r.Member || '') : '';
  }

  function renderTable(data){
    tbody.innerHTML = '';
    if (!data.length){
      const tr = document.createElement('tr');
      tr.innerHTML = '<td class="muted" colspan="7">No rows match your filters.</td>';
      tbody.appendChild(tr);
      return;
    }
    const frag = document.createDocumentFragment();
    for (const r of data){
      const tr = document.createElement('tr');
      const ts = r.Timestamp ? new Date(r.Timestamp) : null;
      const tsText = ts && !isNaN(ts) ? ts.toLocaleString() : '';
      const upn = r.MemberUPN || '';
      const upnHtml = upn ? `<a href="#" class="upn-link" data-upn="${escapeHtml(upn)}">${escapeHtml(upn)}</a>` : '';
      tr.innerHTML = `
        <td>${escapeHtml(tsText)}</td>
        <td>${upnHtml}</td>
        <td>${escapeHtml(r.Member||'')}</td>
        <td>${escapeHtml(r.Role||'')}</td>
        <td>${escapeHtml(r.Justification||'')}</td>
        <td>${escapeHtml(r.Ticket||'')}</td>
        <td>${escapeHtml(r.Activity||'')}</td>
        <td><span class="chip ${r.Result==='success'?'ok':r.Result==='failure'?'bad':''}">${escapeHtml(r.Result||'')}</span></td>
      `;
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
  }

  // click on MemberUPN -> set user filter + scroll to summary
  tbody.addEventListener('click', (e)=>{
    const a = e.target.closest('.upn-link');
    if (!a) return;
    e.preventDefault();
    const upn = a.dataset.upn || '';
    if (!upn) return;
    ensureOption(user, upn);
    user.value = upn;
    applyFilters();
    userSummaryCard.scrollIntoView({behavior:'smooth', block:'start'});
  });

  // === PAG helpers ===
  function getPAGArray(){
    const raw = window.PAG_REPORT;
    if (!raw) return [];
    return Array.isArray(raw) ? raw : [raw];
  }
  function splitList(s){
    if (!s) return [];
    return String(s).split(/[;,\s]+/).map(x=>x.trim()).filter(Boolean);
  }

  // === Roles & Users facet builders (union of activations + PIM report + PAG members) ===
  function getAllRoles(){
    const set = new Set(rows.map(r=>r.Role).filter(Boolean));
    const report = Array.isArray(window.PIM_REPORT) ? window.PIM_REPORT : [];
    for (const r of report){
      const name = (r.AssignedRole || '').trim();
      if (name) set.add(name);
    }
    // (Optional) include PAG AssignedRole(s) in role filter if desired
    for (const p of getPAGArray()){
      const name = (p.AssignedRole||'').trim();
      if (name) set.add(name);
    }
    return Array.from(set).sort();
  }
  function getAllUsers(){
    const set = new Set(rows.map(r=>r.MemberUPN).filter(Boolean));
    const report = Array.isArray(window.PIM_REPORT) ? window.PIM_REPORT : [];
    for (const r of report){
      const upn = (r.Principal || '').trim();
      if (upn) set.add(upn);
    }
    // Include PAG eligible/active members so they appear in the user facet even without activations.
    for (const p of getPAGArray()){
      splitList(p.EligibleGroupMembers).forEach(u=>set.add(u));
      splitList(p.ActiveGroupMembers).forEach(u=>set.add(u));
    }
    return Array.from(set).sort();
  }

  function buildFacets(){
    fillSelect(role, getAllRoles(), 'All roles');
    fillSelect(user, getAllUsers(), 'All users');
  }
  function fillSelect(sel, vals, firstLabel){
    const value = sel.value;
    sel.innerHTML = `<option value="">${firstLabel}</option>` + vals.map(v=>`<option>${escapeHtml(v)}</option>`).join('');
    if (vals.includes(value)) sel.value = value; else sel.value = '';
  }

  // Helper: returns rows filtered by all controls, with option to ignore Role filter
  function filterRows(ignoreRole = false){
    const needle  = q.value.trim().toLowerCase();
    const f       = from.value ? new Date(from.value) : null;
    const t       = to.value   ? new Date(to.value + 'T23:59:59.999') : null;
    const upnSel  = user.value;
    const resSel  = result.value;
    const roleSel = role.value;

    return rows.filter(r => {
      const ts = new Date(r.Timestamp);
      if (f && (!ts || ts < f)) return false;
      if (t && (!ts || ts > t)) return false;
      if (upnSel && r.MemberUPN !== upnSel) return false;
      if (resSel && r.Result !== resSel) return false;
      if (!ignoreRole && roleSel && r.Role !== roleSel) return false;
      if (needle && !Object.values(r).some(v => (v ?? '').toString().toLowerCase().includes(needle))) return false;
      return true;
    }).sort((a,b)=> new Date(b.Timestamp) - new Date(a.Timestamp));
  }

  function applyFilters(){
    filtered = filterRows(false);
    renderTable(filtered);
    drawTrend(filtered);

    renderUserSummary();
    renderEligibleRoles();

    exportBtn.disabled = filtered.length === 0;
    exportUserSummaryBtn.disabled = !canExportUserSummary();
  }

  // Completed detector
  function isCompletedActivation(r){
    const a = (r.Activity || '').toLowerCase();
    return a === 'add member to role completed (pim activation)';
  }

  // Counts completed activations for (user, role)
  function getActivationCount(upn, roleName){
    let n = 0;
    for (const r of rows){
      if (r.MemberUPN?.toLowerCase() !== (upn||'').toLowerCase()) continue;
      if ((r.Role || '') !== roleName) continue;
      if (!isCompletedActivation(r)) continue;
      n++;
    }
    return n;
  }

  // Latest completed activation date for a user's role
  function getLastActivationDate(upn, roleName){
    let latest = null;
    for (const r of rows){
      if (r.MemberUPN?.toLowerCase() !== (upn||'').toLowerCase()) continue;
      if ((r.Role || '') !== roleName) continue;
      if (!isCompletedActivation(r)) continue;
      const d = new Date(r.Timestamp);
      if (!isNaN(d)) latest = (!latest || d > latest) ? d : latest;
    }
    return latest;
  }

  function renderUserSummary(){
    userSummaryBody.innerHTML = '';
    userSummaryNote.textContent = '';

    const upn = user.value;
    const roleSel = role.value;

    // Mode 1: USER selected => their completed activation counts
    if (upn){
      const base = filterRows(true); // ignore Role
      const subset = base.filter(r => r.MemberUPN === upn && isCompletedActivation(r));

      if (subset.length === 0){
        userSummaryNote.textContent = `No completed activations for ${upn} in the current view.`;
        return;
      }

      const counts = new Map();
      for (const r of subset){
        const rn = r.Role || '(Unknown role)';
        counts.set(rn, (counts.get(rn)||0) + 1);
      }
      const items = Array.from(counts.entries()).sort((a,b)=> b[1]-a[1]);
      for (const [rn, count] of items){
        const row = document.createElement('div');
        row.className = 'summary-row';
        row.innerHTML = `<div class="summary-role">${escapeHtml(rn)}</div><div class="summary-count">${count}</div>`;
        userSummaryBody.appendChild(row);
      }
      userSummaryNote.textContent = `Completed activations for ${upn}: ${subset.length}`;
      return;
    }

    // Mode 2: ROLE selected (no user) => eligible users who never activated
    if (roleSel){
      const report = Array.isArray(window.PIM_REPORT) ? window.PIM_REPORT : [];
      const eligUsers = Array.from(new Set(
        report
          .filter(r => (r.AssignmentType || '').toLowerCase().includes('eligible') && (r.AssignedRole || '') === roleSel)
          .map(r => r.Principal).filter(Boolean)
      )).sort();

      const neverActivated = eligUsers.filter(u => getActivationCount(u, roleSel) === 0);

      if (eligUsers.length === 0){
        userSummaryNote.textContent = `No eligible users found for role "${roleSel}".`;
        return;
      }

      if (neverActivated.length === 0){
        userSummaryNote.textContent = `All ${eligUsers.length} eligible user(s) for "${roleSel}" have activated at least once.`;
        return;
      }

      for (const upnNA of neverActivated){
        const row = document.createElement('div');
        row.className = 'summary-row';
        row.innerHTML = `<div class="summary-role">${escapeHtml(upnNA)}</div><div class="summary-count"><span class="x-badge" title="Never activated">✖</span></div>`;
        userSummaryBody.appendChild(row);
      }
      userSummaryNote.textContent = `${neverActivated.length} of ${eligUsers.length} eligible user(s) have never activated "${roleSel}".`;
      return;
    }

    // Mode 3: nothing selected
    userSummaryNote.textContent = 'Select a user to see their completed activations, or pick a role to see eligible users who have never activated it.';
  }

  // ---- Eligible roles list (Dual-mode: by user OR by role) ----
  function isStandingAccess(row){
    const t = (row.AssignmentType || '').toLowerCase();
    if (t.includes('permanent') || t.includes('perm') || t.includes('standing')) return true;
    const sd = (row.AssignmentStartDate || '').toLowerCase();
    const ed = (row.AssignmentEndDate || '').toLowerCase();
    return sd === 'permanent' || ed === 'permanent';
  }

  function deriveTypeBadge(row){
    if (isStandingAccess(row)){
      return { label: 'Perm active', cls: 'perm-badge' };
    }
    const s = (row.AssignmentType || '').toLowerCase();
    if (s.includes('eligible') && s.includes('active')) return { label: 'Eligible (Active)', cls: 'elig-badge' };
    if (s.includes('eligible')) return { label: 'Eligible', cls: 'elig-badge' };
    if (s.includes('active'))   return { label: 'Active',   cls: 'elig-badge' };
    return { label: row.AssignmentType || 'Eligible', cls: 'elig-badge' };
  }

  function renderEligibleRoles(){
    eligibleRolesBody.innerHTML = '';
    eligibleRolesNote.textContent = '';

    const upnSel = user.value;
    const roleSel = role.value;
    const report = Array.isArray(window.PIM_REPORT) ? window.PIM_REPORT : null;

    if (!report){
      eligibleRolesNote.textContent = 'Administrators report not loaded. Ensure AdministratorsReport-PIM.data.js is present.';
      return;
    }

    // MODE A: User selected -> show that user's roles (PIM) + PAG memberships
    if (upnSel){
      eligTitle.textContent = 'Eligible roles';
      eligHint.style.display = '';
      const mine = report.filter(r => (r.Principal || '').toLowerCase() === upnSel.toLowerCase());
      const eligibleOrStanding = mine.filter(r => (r.AssignmentType||'').toLowerCase().includes('eligible') || isStandingAccess(r));

      // --- PIM roles ---
      eligibleOrStanding.sort((a,b)=>{
        const rank = r => isStandingAccess(r) ? 0 :
          ((r.AssignmentType||'').toLowerCase().includes('eligible') && (r.AssignmentType||'').toLowerCase().includes('active')) ? 1 : 2;
        const ra = rank(a), rb = rank(b);
        if (ra !== rb) return ra - rb;
        return (a.AssignedRole||'').localeCompare(b.AssignedRole||'');
      });

      let total = 0;
      for (const r of eligibleOrStanding){
        total++;
        const roleName = r.AssignedRole || '(Unknown)';
        const scope = r.AssignedRoleScope || '/';
        const { label: typeLabel, cls: badgeCls } = deriveTypeBadge(r);

        let lastHtml;
        if (isStandingAccess(r)) {
          lastHtml = `<div class="elig-last" title="Standing access (permanent)">—</div>`;
        } else {
          const last = getLastActivationDate(upnSel, roleName);
          lastHtml = last
            ? `<div class="elig-last" title="${last.toISOString()}">${last.toLocaleDateString()}</div>`
            : `<div class="elig-last"><span class="x-badge" title="Never activated">✖</span></div>`;
        }

        const div = document.createElement('div');
        div.className = 'elig-item';
        div.innerHTML = `
          <div>
            <div>${escapeHtml(roleName)} <span class="pim-badge" title="PIM RBAC role">PIM</span></div>
            <div class="elig-dim">Scope: ${escapeHtml(scope)}</div>
          </div>
          <div><span class="${badgeCls}">${escapeHtml(typeLabel)}</span></div>
          ${lastHtml}
        `;
        eligibleRolesBody.appendChild(div);
      }

      // --- PAG memberships for this user ---
      for (const p of getPAGArray()){
        const elig = new Set(splitList(p.EligibleGroupMembers).map(s=>s.toLowerCase()));
        const active = new Set(splitList(p.ActiveGroupMembers).map(s=>s.toLowerCase()));
        const isElig = elig.has((upnSel||'').toLowerCase());
        const isAct  = active.has((upnSel||'').toLowerCase());
        if (!isElig && !isAct) continue; // not relevant

        total++;
        const roleName = p.AssignedRole || '(Unknown)';
        const scope = p.PrincipalDisplayName || 'PAG Group';
        const typeLabel = isAct ? 'Eligible (Active)' : 'Eligible';
        const badgeCls = 'elig-badge';

        const div = document.createElement('div');
        div.className = 'elig-item';
        div.innerHTML = `
          <div>
            <div>${escapeHtml(roleName)} <span class="pag-badge" title="Privileged Access Group">PAG</span></div>
            <div class="elig-dim">Scope: ${escapeHtml(scope)}</div>
          </div>
          <div><span class="${badgeCls}">${escapeHtml(typeLabel)}</span></div>
          <div class="elig-last" title="PAG membership does not include activation timestamps">—</div>
        `;
        eligibleRolesBody.appendChild(div);
      }

      eligibleRolesNote.textContent = `${total} role${total!==1?'s':''} found for ${upnSel}.`;
      return;
    }

    // MODE B: Role selected (no user) -> show all principals with that role (Eligible, Eligible Active, Perm active)
    if (roleSel){
      eligTitle.textContent = `Principals for role: ${roleSel}`;
      eligHint.style.display = '';
      const rowsForRole = report.filter(r => (r.AssignedRole || '') === roleSel);
      const eligibleOrStanding = rowsForRole.filter(r => (r.AssignmentType||'').toLowerCase().includes('eligible') || isStandingAccess(r));

      if (eligibleOrStanding.length === 0){
        eligibleRolesNote.textContent = `No eligible or standing access principals for "${roleSel}".`;
        return;
      }

      // Order: standing first, then eligible active, then eligible, then by UPN
      eligibleOrStanding.sort((a,b)=>{
        const rank = r => isStandingAccess(r) ? 0 :
          ((r.AssignmentType||'').toLowerCase().includes('eligible') && (r.AssignmentType||'').toLowerCase().includes('active')) ? 1 : 2;
        const ra = rank(a), rb = rank(b);
        if (ra !== rb) return ra - rb;
        return (a.Principal||'').localeCompare(b.Principal||'');
      });

      for (const r of eligibleOrStanding){
        const upn = r.Principal || '';
        const name = findDisplayName(upn);
        const scope = r.AssignedRoleScope || '/';
        const { label: typeLabel, cls: badgeCls } = deriveTypeBadge(r);

        // last-activation logic for this principal & this role
        let lastHtml;
        if (isStandingAccess(r)) {
          lastHtml = `<div class="elig-last" title="Standing access (permanent)">—</div>`;
        } else {
          const last = getLastActivationDate(upn, roleSel);
          lastHtml = last
            ? `<div class="elig-last" title="${last.toISOString()}">${last.toLocaleDateString()}</div>`
            : `<div class="elig-last"><span class="x-badge" title="Never activated">✖</span></div>`;
        }

        const div = document.createElement('div');
        div.className = 'elig-item';
        div.innerHTML = `
          <div>
            <div><a href="#" class="upn-link" data-upn="${escapeHtml(upn)}">${escapeHtml(upn)}</a>${name ? ` &nbsp;<span class=\"elig-dim\">(${escapeHtml(name)})</span>`:''} <span class="pim-badge" title="PIM RBAC role">PIM</span></div>
            <div class="elig-dim">Scope: ${escapeHtml(scope)}</div>
          </div>
          <div><span class="${badgeCls}">${escapeHtml(typeLabel)}</span></div>
          ${lastHtml}
        `;
        eligibleRolesBody.appendChild(div);
      }
      eligibleRolesNote.textContent = `${eligibleOrStanding.length} principal${eligibleOrStanding.length>1?'s':''} found for "${roleSel}".`;

      // Make UPNs clickable here too
      eligibleRolesBody.addEventListener('click', (e)=>{
        const a = e.target.closest('.upn-link');
        if (!a) return;
        e.preventDefault();
        const upn = a.dataset.upn || '';
        if (!upn) return;
        ensureOption(user, upn);
        user.value = upn;
        applyFilters();
        userSummaryCard.scrollIntoView({behavior:'smooth', block:'start'});
      }, { once: true });

      return;
    }

    // No user and no role selected
    eligTitle.textContent = 'Eligible roles';
    eligHint.style.display = '';
    eligibleRolesNote.textContent = 'Select a user or a role to see details here.';
  }
  // ---------------------------------------------------------------

  // ---- Export helpers (User Summary: eligible/standing roles for selected user) ----
  function getEligibleForSelectedUser(){
    const upn = user.value;
    if (!upn) return [];
    const report = Array.isArray(window.PIM_REPORT) ? window.PIM_REPORT : [];
    const arr = report.filter(r =>
      (r.Principal || '').toLowerCase() === upn.toLowerCase() &&
      ( (r.AssignmentType||'').toLowerCase().includes('eligible') || isStandingAccess(r) )
    );

    // add PAG entries (eligible/active) to export dataset
    for (const p of getPAGArray()){
      const elig = new Set(splitList(p.EligibleGroupMembers).map(s=>s.toLowerCase()));
      const active = new Set(splitList(p.ActiveGroupMembers).map(s=>s.toLowerCase()));
      const isElig = elig.has((upn||'').toLowerCase());
      const isAct  = active.has((upn||'').toLowerCase());
      if (!isElig && !isAct) continue;
      arr.push({
        Principal: upn,
        AssignedRole: p.AssignedRole,
        AssignedRoleScope: p.PrincipalDisplayName || 'PAG Group',
        AssignmentType: isAct ? 'Eligible (Active)' : 'Eligible',
        _isPag: true
      });
    }

    return arr;
  }

  function canExportUserSummary(){
    const upn = user.value;
    if (!upn) return false;
    return getEligibleForSelectedUser().length > 0;
  }

  function exportUserSummaryCsv(){
    const upn = user.value;
    if (!upn) return;

    const eligible = getEligibleForSelectedUser();
    if (eligible.length === 0){
      showInfo(`No eligible/standing roles found for ${upn} to export.`);
      return;
    }

    const header = ["UserUPN","Role","Scope","AssignmentTypeDisplay","LastActivated","NeverActivated","CompletedActivations"];
    const lines = [header.join(',')];

    for (const r of eligible){
      const isPag = r._isPag === true;
      const roleName = r.AssignedRole || '';
      const scope = r.AssignedRoleScope || '';
      const displayType = isPag ? (r.AssignmentType || 'Eligible') : deriveTypeBadge(r).label;

      let lastStr = '';
      let never = '';
      let count = 0;

      if (isPag){
        // We don't track activation timestamps for PAG at the user level here
        lastStr = '';
        never = '';
        count = 0;
      } else {
        const isPerm = isStandingAccess(r);
        const last = isPerm ? null : getLastActivationDate(upn, roleName);
        lastStr = last ? last.toISOString().slice(0,10) : "";
        count = isPerm ? 0 : getActivationCount(upn, roleName);
        never = isPerm ? "—" : (count === 0 ? "Yes" : "No");
      }

      const vals = [upn, roleName, scope, displayType, lastStr, never, String(count)]
        .map(v => {
          const s = (v ?? '').toString();
          return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
        });

      lines.push(vals.join(','));
    }

    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `PIM_UserSummary_${upn.replace(/[^a-zA-Z0-9._-]/g,'_')}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }
  // ------------------------------------------------------------------------

  function drawTrend(data){
    const ctx = trendCanvas.getContext('2d');
    ctx.clearRect(0,0,trendCanvas.width,trendCanvas.height);

    const dpr = window.devicePixelRatio || 1;
    const w = trendCanvas.clientWidth, h = trendCanvas.clientHeight;
    trendCanvas.width = Math.floor(w * dpr);
    trendCanvas.height = Math.floor(h * dpr);
    ctx.scale(dpr, dpr);

    const map = new Map();
    for (const r of data){
      const d = new Date(r.Timestamp);
      if (!isNaN(d)) {
        const key = d.toISOString().slice(0,10);
        map.set(key, (map.get(key)||0)+1);
      }
    }
    const points = Array.from(map.entries()).sort(([a],[b])=> a.localeCompare(b))
      .map(([date,count])=>({date, count}));

    ctx.strokeStyle = '#e5e7eb';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(40, 10);
    ctx.lineTo(40, h-30);
    ctx.lineTo(w-10, h-30);
    ctx.stroke();

    if (points.length === 0){
      ctx.fillStyle = '#64748b';
      ctx.fillText('No data for trend', 50, Math.max(20, h/2));
      return;
    }

    const maxY = Math.max(...points.map(p=>p.count));
    const left = 40, right = w-10, top = 10, bottom = h-30;
    const innerW = right-left, innerH = bottom-top;

    ctx.fillStyle = '#64748b';
    ctx.font = '12px system-ui';
    const yTicks = Math.min(5, maxY);
    for (let i=0;i<=yTicks;i++){
      const val = Math.round(maxY * i / (yTicks || 1));
      const y = bottom - (val/(maxY||1))*innerH;
      ctx.fillText(String(val), 8, y+4);
      ctx.strokeStyle = '#f1f5f9';
      ctx.beginPath(); ctx.moveTo(left, y); ctx.lineTo(right, y); ctx.stroke();
    }

    const xLabelIdx = new Set([0, Math.floor(points.length/2), points.length-1]);
    xLabelIdx.forEach(i=>{
      const x = left + (i/(points.length-1||1))*innerW;
      ctx.fillStyle = '#64748b';
      ctx.fillText(points[i].date, x-30, bottom+18);
    });

    ctx.strokeStyle = '#1f2937';
    ctx.lineWidth = 2;
    ctx.beginPath();
    points.forEach((p,i)=>{
      const x = left + (i/(points.length-1||1))*innerW;
      const y = bottom - (p.count/(maxY||1))*innerH;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }

  function exportCsv(){
    const header = ["Timestamp","MemberUPN","Member","Role","Justification","Ticket","Activity","Result"];
    const lines = [header.join(',')];
    for (const r of filtered){
      const row = header.map(h=>{
        const v = (r[h] ?? '').toString();
        return /[",\n]/.test(v) ? `"${v.replace(/"/g,'""')}"` : v;
      }).join(',');
      lines.push(row);
    }
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'PIM_Activations_filtered.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function initialLoad(){
    if (Array.isArray(window.PIM_ACTIVATIONS)) {
      hideBanner();
      ingest(normalize(window.PIM_ACTIVATIONS));
    } else {
      showInfo('Data bundles not found. Ensure PIM_Activations.data.js and AdministratorsReport-PIM.data.js are placed beside this page.');
      renderTable([]);
      buildFacets();
      renderUserSummary();
      renderEligibleRoles();
      exportUserSummaryBtn.disabled = !canExportUserSummary();
    }
  }

  function ingest(data){
    rows = data;
    buildFacets();
    applyFilters();
  }

  // wiring
  [q, role, user, result, from, to].forEach(el=> el.addEventListener('input', applyFilters));
  exportBtn.addEventListener('click', exportCsv);
  exportUserSummaryBtn.addEventListener('click', exportUserSummaryCsv);

  // Reset view: clear all filters and re-render
  function resetView(){
    q.value = '';
    role.value = '';
    user.value = '';
    result.value = '';
    from.value = '';
    to.value = '';
    hideBanner();
    applyFilters();
    window.scrollTo({top: 0, behavior: 'smooth'});
  }
  resetBtn.addEventListener('click', resetView);

  initialLoad();
})();
</script>
</body>
</html>